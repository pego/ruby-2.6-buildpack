#!/bin/sh

BUILD_DIR=$1
CACHE_DIR=$2

echo "Setting up environment variables for OpenSSL..."
export PATH="/usr/bin:$PATH"
export LDFLAGS="-L/usr/lib -Wl,-rpath,/usr/lib"
export CPPFLAGS="-I/usr/include"
export PKG_CONFIG_PATH="/usr/lib/pkgconfig"

echo "Checking OpenSSL version on Heroku..."
openssl version -a || echo "‚ö†Ô∏è OpenSSL not found!"

echo "Installing Ruby 2.7.8 with OpenSSL 3.0.13..."
mkdir -p $BUILD_DIR/tmp_ruby_build
cd $BUILD_DIR/tmp_ruby_build

# Scarica e decomprime Ruby
curl -o ruby.tar.gz https://cache.ruby-lang.org/pub/ruby/2.7/ruby-2.7.8.tar.gz
tar -xzvf ruby.tar.gz --strip-components=1

# Debug: Verifica che i file siano stati estratti correttamente
ls -l

# Configura Ruby forzando i percorsi OpenSSL
echo "Configuring Ruby with OpenSSL..."
./configure --prefix=$BUILD_DIR/.ruby \
  --with-openssl-dir=/usr \
  --enable-shared \
  LDFLAGS="-L/usr/lib -Wl,-rpath,/usr/lib" \
  CPPFLAGS="-I/usr/include" \
  OPENSSL_CFLAGS="-I/usr/include" \
  OPENSSL_LIBS="-L/usr/lib -lssl -lcrypto"

# Debug: Verifica se la configurazione √® andata a buon fine
if [ $? -ne 0 ]; then
  echo "‚ùå Errore durante la configurazione di Ruby!"
  cat config.log | grep -i openssl || echo "‚ö†Ô∏è OpenSSL not found in config.log!"
  exit 1
fi

# Compiliamo Ruby
echo "Compiling Ruby..."
make -j$(nproc)
if [ $? -ne 0 ]; then
  echo "‚ùå Errore durante la compilazione di Ruby!"
  exit 1
fi

# Installiamo Ruby
echo "Installing Ruby..."
make install
if [ $? -ne 0 ]; then
  echo "‚ùå Errore durante l'installazione di Ruby!"
  exit 1
fi

# Debug: Controlla se il binario di Ruby √® stato creato
if [ ! -f "$BUILD_DIR/.ruby/bin/ruby" ]; then
  echo "‚ùå Errore: Ruby non √® stato installato correttamente!"
  ls -l $BUILD_DIR/.ruby
  exit 1
fi

# Debug: Controlliamo se Ruby √® linkato a OpenSSL
echo "Verifying OpenSSL support in Ruby..."
$BUILD_DIR/.ruby/bin/ruby -ropenssl -e 'puts OpenSSL::OPENSSL_VERSION' || echo "‚ö†Ô∏è OpenSSL non trovato in Ruby!"

# Forza la compilazione dell'estensione OpenSSL
echo "üîß Forzando la compilazione dell'estensione OpenSSL..."
cd $BUILD_DIR/.ruby/lib/ruby/2.7.0/ext/openssl
$BUILD_DIR/.ruby/bin/ruby extconf.rb
make && make install

# Debug finale
echo "Verifying OpenSSL support after installation..."
$BUILD_DIR/.ruby/bin/ruby -ropenssl -e 'puts OpenSSL::OPENSSL_VERSION' || echo "‚ö†Ô∏è OpenSSL non trovato in Ruby!"

echo "‚úÖ Ruby installation completed successfully!"