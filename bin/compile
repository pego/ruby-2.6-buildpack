#!/bin/sh

BUILD_DIR=$1
CACHE_DIR=$2

echo "Setting up environment variables for OpenSSL..."
export PATH="/usr/bin:$PATH"
export LDFLAGS="-L/usr/lib"
export CPPFLAGS="-I/usr/include"
export PKG_CONFIG_PATH="/usr/lib/pkgconfig"

echo "Installing Ruby 2.7.8 with OpenSSL 3.0.13..."
mkdir -p $BUILD_DIR/tmp_ruby_build
cd $BUILD_DIR/tmp_ruby_build

# Scarica e decomprime Ruby
curl -o ruby.tar.gz https://cache.ruby-lang.org/pub/ruby/2.7/ruby-2.7.8.tar.gz
tar -xzvf ruby.tar.gz --strip-components=1

# Configura e compila Ruby con OpenSSL 3.0
./configure --prefix=$BUILD_DIR/.ruby \
  --with-openssl-dir=/usr \
  LDFLAGS="-L/usr/lib -Wl,-rpath,/usr/lib" \
  CPPFLAGS="-I/usr/include"

make -j$(nproc) && make install

# Verifica che Ruby sia stato installato
if [ ! -f "$BUILD_DIR/.ruby/bin/ruby" ]; then
  echo "Errore: Ruby non Ã¨ stato installato correttamente!"
  exit 1
fi

# Forza la compilazione dell'estensione OpenSSL di Ruby
echo "Forcing OpenSSL extension compilation..."
cd $BUILD_DIR/.ruby/lib/ruby/2.7.0/ext/openssl
$BUILD_DIR/.ruby/bin/ruby extconf.rb
make && make install

# Controlla se Ruby ora riconosce OpenSSL
$BUILD_DIR/.ruby/bin/ruby -ropenssl -e 'puts OpenSSL::OPENSSL_VERSION'

# Aggiungi Ruby al PATH
mkdir -p $BUILD_DIR/.profile.d
echo "export PATH=$BUILD_DIR/.ruby/bin:\$PATH" >> $BUILD_DIR/.profile.d/ruby.sh

# Installa Bundler nella versione richiesta
$BUILD_DIR/.ruby/bin/gem install bundler -v 2.4.21

# Installa le gemme dell'app
cd $BUILD_DIR
$BUILD_DIR/.ruby/bin/bundle install --deployment --without development test