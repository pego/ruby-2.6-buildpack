#!/bin/sh

BUILD_DIR=$1
CACHE_DIR=$2

echo "ğŸ”§ Setting up environment variables..."
export PATH="/usr/bin:$PATH"
export LDFLAGS="-L/usr/lib -Wl,-rpath,/usr/lib"
export CPPFLAGS="-I/usr/include"
export PKG_CONFIG_PATH="/usr/lib/pkgconfig"

echo "ğŸ“¦ Installing OpenSSL 1.1.1..."
apt-get update && apt-get install -y \
  libssl1.1 \
  libssl-dev \
  libreadline-dev \
  zlib1g-dev \
  libyaml-dev \
  libffi-dev \
  libgdbm-dev \
  libncurses5-dev \
  libgmp-dev

echo "ğŸ” Checking OpenSSL version..."
openssl version -a

echo "ğŸ”§ Installing Ruby 2.6.10 with OpenSSL 1.1.1..."
mkdir -p $BUILD_DIR/tmp_ruby_build
cd $BUILD_DIR/tmp_ruby_build

# Scarica e decomprime Ruby 2.6.10
curl -o ruby.tar.gz https://cache.ruby-lang.org/pub/ruby/2.6/ruby-2.6.10.tar.gz
tar -xzvf ruby.tar.gz --strip-components=1

# Configura Ruby per usare OpenSSL 1.1.1
echo "âš™ï¸ Configuring Ruby..."
./configure --prefix=$BUILD_DIR/.ruby \
  --with-openssl-dir=/usr \
  --enable-shared \
  LDFLAGS="-L/usr/lib -Wl,-rpath,/usr/lib" \
  CPPFLAGS="-I/usr/include" \
  OPENSSL_CFLAGS="-I/usr/include" \
  OPENSSL_LIBS="-L/usr/lib -lssl -lcrypto"

if [ $? -ne 0 ]; then
  echo "âŒ Errore durante la configurazione di Ruby!"
  exit 1
fi

# Compilazione
echo "ğŸ› ï¸ Compiling Ruby..."
make -j$(nproc)

if [ $? -ne 0 ]; then
  echo "âŒ Errore durante la compilazione di Ruby!"
  exit 1
fi

# Installazione
echo "ğŸ“¦ Installing Ruby..."
make install

if [ $? -ne 0 ]; then
  echo "âŒ Errore durante l'installazione di Ruby!"
  exit 1
fi

# Debug: Verifica che Ruby sia stato installato
if [ ! -f "$BUILD_DIR/.ruby/bin/ruby" ]; then
  echo "âŒ Errore: Ruby non Ã¨ stato installato correttamente!"
  ls -l $BUILD_DIR/.ruby
  exit 1
fi

# Verifica se Ruby riconosce OpenSSL
echo "ğŸ” Checking OpenSSL in Ruby..."
$BUILD_DIR/.ruby/bin/ruby -ropenssl -e 'puts OpenSSL::OPENSSL_VERSION'

# Forza la compilazione dell'estensione OpenSSL
echo "ğŸ”§ Forcing OpenSSL extension compilation..."
cd $BUILD_DIR/.ruby/lib/ruby/2.6.0/ext/openssl
$BUILD_DIR/.ruby/bin/ruby extconf.rb
make && make install

# Debug finale
echo "âœ… Verifying OpenSSL support after installation..."
$BUILD_DIR/.ruby/bin/ruby -ropenssl -e 'puts OpenSSL::OPENSSL_VERSION'

echo "ğŸš€ Ruby 2.6.10 installed successfully with OpenSSL 1.1.1!"